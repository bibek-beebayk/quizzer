{% extends "base.html" %}
{% load static %}

{% block meta %}
<link rel="stylesheet" type="text/css" href="{% static 'css/blog/detail.css' %}">
<meta name="title" content="quizNfacts | Blog | {{blog.title}}">
<meta name="description" content="{{blog.excerpt}}">
<meta name="keywords" content="{{blog.keywords}}">
<title>quizNfacts | Blogs | {{blog.title}}</title>
{% endblock %}

{% block content %}


<div id="editCommentModal" class="modal">
    <div class="modal-content">
        <h3>Edit Comment</h3>
        <form method="POST" action="{% url 'edit_comment' %}" id="editCommentForm">
            {% csrf_token %}
            <input type="hidden" name="comment_id" id="commentId">
            <div>
                <label for="comment">Comment</label>
                <div class="form-group">
                    <textarea name="comment" placeholder="Your Comment" required></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancelEdit" class="btn btn-secondary"
                    style="background: transparent;">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
            <p style="display: none;" id="passwordChangeError"></p>
        </form>
    </div>

</div>

<div class="blog-detail-container">
    <article class="blog-content">
        <header class="article-header">
            <h1 class="article-title">{{ blog.title }}</h1>
            <div class="article-meta">
                <span><i class="far fa-calendar-alt"></i> {{ blog.publish_at|date:"F d, Y" }}</span>
                {% if blog.author %}
                <span><i class="far fa-user"></i> {{ blog.author.name }}</span>
                {% endif %}
                <span><i class="far fa-folder"></i> {{blog.category_str|safe}}</span>
            </div>
        </header>

        {% if blog.cover_image %}
        <img src="{{blog.cover_image.url}}" alt="{{ blog.title }}" class="article-cover">
        {% endif %}

        <div class="article-body">
            {% for section in blog.sections.all|dictsort:"order" %}
            {% if section.title %}
            <h2>{{section.title}}</h2>
            {% endif %}

            {% if section.image %}
            <figure style="text-align: center; margin: 2rem 0;">
                <img src="{{section.image.url}}"
                    alt="{% if section.image_alt %}{{section.image_alt}}{% else %}{{section.title}}{% endif %}"
                    class="section-image">
                {% if section.image_label %}
                <figcaption style="font-size: 0.9rem; color: var(--color-text-secondary); margin-top: 0.5rem;">
                    {{section.image_label}}
                </figcaption>
                {% endif %}
            </figure>
            {% endif %}

            {{ section.content|safe }}
            {% endfor %}
        </div>
    </article>

    <div class="comments-section">
        <h3><i class="far fa-comments"></i> Comments</h3>

        {% if user.is_authenticated %}
        {% if not has_commented %}
        <div class="comment-form">
            <form method="post">
                {% csrf_token %}
                <textarea name="comment" placeholder="What are your thoughts?" required></textarea>
                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>
        </div>
        {% else %}
        <div class="alert success">You have shared your thoughts on this post.</div>
        {% endif %}
        {% else %}
        <div class="alert" style="background: rgba(255, 255, 255, 0.05); text-align: center;">
            Please <a href="/login">login</a> to leave a comment.
        </div>
        {% endif %}

        <div class="comments-list">
            {% for comment in blog.comments.all %}
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-author">{{ comment.user.email }}</span>
                    <span class="comment-date">{{ comment.created_at|date:"M d, Y" }}</span>
                </div>
                <div class="comment-content">
                    {{ comment.text }}
                </div>
                {% if comment.user == user %}
                <div class="comment-actions">
                    <button class="action-btn edit" onClick="handleEditComment('{{comment.id}}', '{{comment.text}}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="action-btn delete" onclick="handleDeleteComment('{{comment.id}}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p style="text-align: center; color: var(--color-text-secondary); margin-top: 2rem;">
                No comments yet. Be the first to join the discussion!
            </p>
            {% endfor %}
        </div>
    </div>

    <div class="related-posts">
        <h3>You might also like</h3>
        <div class="related-grid">
            {% for post in related_posts %}
            <a href="/blogs/{{post.slug}}" class="blog-card" style="text-decoration: none; padding: 1rem;">
                <h4 style="margin-bottom: 0.5rem; color: var(--color-text-primary);">{{ post.title }}</h4>
                <small style="color: var(--color-secondary);">{{ post.category.name }}</small>
            </a>
            {% empty %}
            <p style="color: var(--color-text-secondary);">No related posts found.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div id="deleteCommentModal" class="modal">
    <div class="modal-content">
        <h3>Are you sure? This action is irreversible.</h3>
        <form method="POST" action="{% url 'delete_comment' %}" id="deleteCommentForm">
            {% csrf_token %}
            <input type="hidden" name="comment_id" id="deleteCommentId">
            <div class="modal-actions">
                <button type="button" id="cancelDelete" class="btn btn-secondary"
                    style="background: transparent;">Cancel</button>
                <button type="submit" class="btn btn-primary"
                    style="background: var(--color-error); border-color: var(--color-error);">Delete</button>
            </div>
            <p style="display: none;" id="passwordChangeError"></p>
        </form>
    </div>
</div>

<script>

    const cancelEdit = document.getElementById("cancelEdit");
    const cancelDelete = document.getElementById("cancelDelete");
    const editCommentModal = document.getElementById("editCommentModal");

    const handleDeleteComment = (commentId) => {
        deleteCommentModal.style.display = "block";
        const deleteCommentId = document.getElementById("deleteCommentId");
        deleteCommentId.value = commentId;
    };

    const handleEditComment = (commentId, commentText) => {
        const commentTextArea = document.querySelector("textarea[name='comment']");
        console.log("Comment: ", commentText)
        commentTextArea.value = commentText;
        const commentIdInput = document.getElementById("commentId");
        commentIdInput.value = commentId;
        editCommentModal.style.display = "block";
    };

    cancelEdit.onclick = () => {
        editCommentModal.style.display = "none";
    };

    cancelDelete.onclick = () => {
        deleteCommentModal.style.display = "none";
    };

</script>
{% endblock %}