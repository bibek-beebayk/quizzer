{% extends "base.html" %}
{% load static %}

{% block meta %}
<link rel="stylesheet" type="text/css" href="{% static 'css/index.css' %}">
<title>quizNfacts - Test Your Knowledge</title>
<meta name="title" content="quizNfacts">
<meta name="description"
    content="A place to read and test your knowledge. Read informative blogs and take quizzes to test your knowledge on different topics.">
<meta name="keywords" content="quiz, facts, interesting facts, gk, mcq, general knowledge">

<meta property="og:title" content="quizNfacts">
<meta property="og:description"
    content="A place to read and test your knowledge. Read informative blogs and take quizzes to test your knowledge on different topics.">
<meta property="og:image" content="https://worldstories.net/static/assets/logo-no-background.ca68ee56464b.png">
<meta property="og:url" content="https://worldstories.net">

<meta name="twitter:title" content="quizNfacts">
<meta name="twitter:description"
    content="A place to read and test your knowledge. Read informative blogs and take quizzes to test your knowledge on different topics.">
{% endblock %}

{% block content %}

<div class="hero-section">
    <div class="container">
        <!-- Random Question Card -->
        <div class="card random-question-card">
            <div class="question-header">
                <span><i class="fas fa-question-circle"></i> Random Question</span>
                <a href="/" class="shuffle-btn" title="Get another question"><i class="fas fa-sync-alt"></i></a>
            </div>

            <h2 class="question-text">{{random_question.question_text}}</h2>

            <div class="answers-grid">
                {% for answer in random_question.shuffled_answers %}
                <div class="answer-btn" id="{{answer.id}}" onclick="handleAnswerClick(event)"
                    data-is-correct="{{answer.is_correct}}">
                    {{answer}}
                </div>
                {% endfor %}
            </div>

            <div class="mt-3" style="margin-top: 15px; color: var(--color-text-secondary); font-size: 0.8rem;">
                Category: {{random_question.categories_str}}
            </div>
        </div>
    </div>
</div>

<div class="container categories-section">
    <div class="section-header">
        <h2>Explore Categories</h2>
        {% if user.is_authenticated %}
        <button class="btn btn-primary" id="generate_quiz" onClick='openQuizModal()'>
            <i class="fas fa-magic" style="margin-right: 5px;"></i> Custom Quiz
        </button>
        {% endif %}
    </div>

    <div class="category-grid">
        <a href="/quiz/?category=random" class="category-card">
            <div class="category-name">Randomized Quiz</div>
            <div class="category-count">{{questions_count}} Questions</div>
        </a>
        {% for category in categories %}
        <a href="/quiz/?category={{category.id}}" class="category-card">
            <div class="category-name">{{category.name}}</div>
            <div class="category-count">{{category.questions.count}} Questions</div>
        </a>
        {% endfor %}
    </div>
</div>

<div class="container">
    <div class="section-header">
        <h2>Newest Quizzes</h2>
        <a href="/quiz-list/" class="btn btn-secondary">View All</a>
    </div>

    <div class="recent-grid">
        {% for quiz in recent_quizzes %}
        <div class="card quiz-card">
            <h3>{{quiz.name}}</h3>
            <div class="quiz-meta">
                <i class="far fa-calendar-alt"></i> {{quiz.publish_at|date:"M d, Y"}}
                {% if quiz.category %}
                <span>&bull;</span> {{quiz.category.name}}
                {% endif %}
            </div>
            <a href="/quiz/?quiz={{quiz.id}}" class="btn btn-primary w-100" style="margin-top: auto;">Start Quiz</a>
        </div>
        {% endfor %}
    </div>

    <div class="section-header">
        <h2>Latest from the Blog</h2>
        <a href="/blogs/" class="btn btn-secondary">Read More</a>
    </div>

    <div class="recent-grid">
        {% for blog in recent_blogs %}
        <div class="card quiz-card">
            <img src="{{blog.cover_image.url}}" alt="{{blog.title}}" class="blog-card-img">
            <h3>{{blog.title}}</h3>
            <div class="quiz-meta">
                <i class="far fa-calendar-alt"></i> {{blog.publish_at|date:"M d, Y"}}
            </div>
            <a href="/blogs/{{blog.slug}}" class="btn btn-secondary w-100" style="margin-top: auto;">Read Post</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal -->
<div id="generateQuizModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Custom Quiz Generator</h3>
            <button onclick="closeQuizModal()" style="background: none; border: none; color: white; cursor: pointer;">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>

        <form method="post" action="{% url 'quiz' %}">
            {% csrf_token %}
            <h4 style="font-size: 1rem; color: var(--color-text-secondary);">Select Topics</h4>
            <div class="modal-interests">
                {% for interest in all_categories %}
                <label class="interest-label">
                    <input type="checkbox" name="interests" value="{{ interest.id }}" class="interest-checkbox">
                    <span>{{ interest }}</span>
                </label>
                {% endfor %}
            </div>

            <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                <label for="question_count" style="display: block; margin-bottom: 5px;">Number of Questions
                    (10-20)</label>
                <input type="number" name="count" id="question_count" value="10" min="10" max="20" class="form-control">
                <span id="countError"
                    style="color: var(--color-error); font-size: 0.8rem; display: none; margin-top: 5px;"></span>
            </div>

            <div class="modal-actions">
                <button type="button" onclick="closeQuizModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" id="submitQuizData" class="btn btn-primary">Generate Quiz</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Logic for Homepage Interactions
    const quizModal = document.getElementById("generateQuizModal");
    const questionCountInput = document.getElementById("question_count");
    const countErrorSpan = document.getElementById("countError");
    const submitQuizButton = document.getElementById('submitQuizData');

    function openQuizModal() {
        quizModal.style.display = "flex";
    }

    function closeQuizModal() {
        quizModal.style.display = "none";
    }

    if (questionCountInput) {
        questionCountInput.addEventListener('change', function () {
            const val = parseInt(this.value);
            if (val > 20 || val < 10) {
                countErrorSpan.style.display = "block";
                submitQuizButton.disabled = true;
                countErrorSpan.innerText = "Please enter a value between 10 and 20.";
            } else {
                countErrorSpan.style.display = "none";
                submitQuizButton.disabled = false;
            }
        });
    }

    // Interactive Answer Handling
    function handleAnswerClick(event) {
        const target = event.target;
        const isCorrect = target.dataset.isCorrect === "True";

        if (isCorrect) {
            target.classList.add('correct');
        } else {
            target.classList.add('wrong');
            // Highlight correct one
            document.querySelectorAll('.answer-btn').forEach(btn => {
                if (btn.dataset.isCorrect === "True") {
                    btn.classList.add('correct');
                }
            });
        }

        // Slight delay before reload to see effect
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    }

    // Close modal on outside click
    window.onclick = function (event) {
        if (event.target == quizModal) {
            closeQuizModal();
        }
    }
</script>

{% endblock %}