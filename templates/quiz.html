{% extends "base.html" %}

{% block content %}
<style>
    /* Base styles */
    .main-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgb(43, 43, 43);
        padding: 10px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    .options-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
        width: 100%;
    }

    .quiz-overview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
        font-size: 14px;
    }

    .option-container {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        border-radius: 4px;
        transition: background-color 0.3s;
        width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        align-items: center;
    }

    .option-container span {
        flex: 1;
        font-size: 14px;
    }

    .option-container.correct {
        background-color: rgba(0, 255, 0, 0.1);
        border: 1px solid #00a000;
    }

    .option-container.incorrect {
        background-color: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff0000;
    }

    .radio-input {
        min-width: 20px;
        height: 20px;
        margin-top: 2px;
    }

    .radio-input:disabled {
        opacity: 0.6;
    }

    .option-container.disabled {
        opacity: 0.7;
    }

    .answer-feedback {
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
    }

    .answer-feedback.visible {
        opacity: 1;
    }

    /* Mobile-optimized stats panel */
    .stats-panel {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        background-color: white;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 5px;
    }

    .stats-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .stats-label {
        color: #666;
        font-size: 12px;
    }

    .stats-value {
        font-weight: bold;
        color: #333;
        font-size: 14px;
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background-color: #eee;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-fill {
        height: 100%;
        background-color: #4CAF50;
        width: 0%;
        transition: width 0.3s ease;
    }

    /* Question block styling */
    .question-block {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 10px;
        box-sizing: border-box;
    }

    .question-block h3 {
        font-size: 16px;
        font-weight: 400;
        line-height: 1.4;
        margin-bottom: 15px;
    }

    /* Warning message */
    .warning-message {
        background-color: rgb(255, 222, 222);
        width: 100%;
        text-align: center;
        padding: 8px;
        font-weight: 100;
        border-radius: 5px;
        color: rgb(0, 0, 0);
        font-size: 14px;
        margin: 10px 0;
        box-sizing: border-box;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        .quiz-overview span {
            font-size: 12px;
        }

        .option-container {
            padding: 8px;
        }

        .stats-panel {
            padding: 8px;
        }

        .question-block h3 {
            font-size: 14px;
        }
    }
</style>

<div class="stats-panel">
    <div class="stats-item">
        <span class="stats-label">Progress:</span>
        <span class="stats-value">
            <span id="attempted">0</span>/<span id="total">{{questions|length}}</span>
        </span>
    </div>
    <div class="stats-item">
        <span class="stats-label">Correct:</span>
        <span class="stats-value" id="correct">0</span>
    </div>
    <div class="stats-item">
        <span class="stats-label">Score:</span>
        <span class="stats-value"><span id="percentage">0</span>%</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
</div>

<div class="main-container">
    <h2 style="font-weight: 100; font-size: 20px; text-align: center;">{{category}} Quiz</h2>

    <div class="quiz-overview">
        <span>Questions: {{questions|length}}</span>
        <span>Time: Untimed</span>
        <span>Difficulty: Mixed</span>
    </div>

    <p class="warning-message">
        <i>You can only choose once. Choose wisely.</i>
    </p>

    <div class="quiz-container">
        <form action="" method="post">
            {% csrf_token %}
            {% for question in questions %}
            <div class="question-block" data-question-id="{{question.id}}">
                <h3>{{forloop.counter}}. {{question}}</h3>
                <div class="options-container">
                    {% for answer in question.shuffled_answers %}
                    <div class="option-container" data-is-correct="{{answer.is_correct|lower}}">
                        <input type="radio" name="{{question.id}}" value="{{answer.id}}" class="radio-input"
                            onchange="checkAnswer(this)" />
                        <span>{{answer}}</span>
                        <span class="answer-feedback"></span>
                    </div>
                    {% endfor %}
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
            </div>
            {% endfor %}
        </form>
    </div>
</div>

<script>
    let stats = {
        attempted: 0,
        correct: 0,
        total: 0,

        update: function(isCorrect) {
            this.attempted++;
            if (isCorrect) this.correct++;
            this.updateDisplay();
        },

        updateDisplay: function() {
            document.getElementById('attempted').textContent = this.attempted;
            document.getElementById('correct').textContent = this.correct;
            const percentage = this.attempted ? Math.round((this.correct / this.attempted) * 100) : 0;
            document.getElementById('percentage').textContent = percentage;
            document.getElementById('progress-fill').style.width = `${(this.attempted / this.total) * 100}%`;
        }
    };

    function checkAnswer(radioButton) {
        const optionContainer = radioButton.closest('.option-container');
        const questionBlock = radioButton.closest('.question-block');
        const allOptions = questionBlock.querySelectorAll('.option-container');
        const allRadios = questionBlock.querySelectorAll('.radio-input');
        const isCorrect = optionContainer.dataset.isCorrect === 'true';

        stats.update(isCorrect);

        allRadios.forEach(radio => radio.disabled = true);
        allOptions.forEach(option => {
            option.classList.add('disabled');
            option.classList.remove('correct', 'incorrect');
            option.querySelector('.answer-feedback').textContent = '';
            option.querySelector('.answer-feedback').classList.remove('visible');
        });

        const feedbackSpan = optionContainer.querySelector('.answer-feedback');
        if (isCorrect) {
            optionContainer.classList.add('correct');
            feedbackSpan.textContent = '✓';
        } else {
            optionContainer.classList.add('incorrect');
            feedbackSpan.textContent = '✗';

            allOptions.forEach(option => {
                if (option.dataset.isCorrect === 'true') {
                    option.classList.add('correct');
                    option.querySelector('.answer-feedback').textContent = '✓';
                    option.querySelector('.answer-feedback').classList.add('visible');
                }
            });
        }
        feedbackSpan.classList.add('visible');

        // Scroll to the next unanswered question
        const nextQuestionBlock = [...document.querySelectorAll('.question-block')]
            .find(block => !block.querySelector('input:disabled'));
        
        if (nextQuestionBlock) {
            setTimeout(() => {
                nextQuestionBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        stats.updateDisplay();

        const checkedInputs = document.querySelectorAll('input[type="radio"]:checked');
        checkedInputs.forEach(input => {
            const isCorrect = input.closest('.option-container').dataset.isCorrect === 'true';
            stats.update(isCorrect);
            checkAnswer(input);
        });
    });
</script>
{% endblock %}