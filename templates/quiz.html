{% extends "base.html" %}

{% block content %}
<style>
    /* Base styles */
    .main-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgb(43, 43, 43);
        padding: 10px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    .options-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
        width: 100%;
    }

    .quiz-overview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center;
        font-size: 14px;
    }

    .option-container {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        border-radius: 4px;
        transition: background-color 0.3s;
        width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
        align-items: center;
    }

    .option-container span {
        flex: 1;
        font-size: 14px;
    }

    .option-container.correct {
        background-color: rgba(0, 255, 0, 0.1);
        border: 1px solid #00a000;
    }

    .option-container.incorrect {
        background-color: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff0000;
    }

    .radio-input {
        min-width: 20px;
        height: 20px;
        margin-top: 2px;
        cursor: pointer;
    }

    .radio-input:disabled {
        opacity: 0.6;
    }

    .option-container.disabled {
        opacity: 0.7;
    }

    .answer-feedback {
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
    }

    .answer-feedback.visible {
        opacity: 1;
    }

    /* Mobile-optimized stats panel */
    .stats-panel {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        background-color: white;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 48;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 5px;
    }

    .stats-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .stats-label {
        color: #666;
        font-size: 12px;
    }

    .stats-value {
        font-weight: bold;
        color: #333;
        font-size: 14px;
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background-color: #eee;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-fill {
        height: 100%;
        background-color: #4CAF50;
        width: 0%;
        transition: width 0.3s ease;
    }

    /* Question block styling */
    .question-block {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 10px;
        box-sizing: border-box;
    }

    .question-block h3 {
        font-size: 16px;
        font-weight: 400;
        line-height: 1.4;
        margin-bottom: 15px;
    }

    /* Warning message */
    .warning-message {
        background-color: rgb(255, 222, 222);
        width: 100%;
        text-align: center;
        padding: 8px;
        font-weight: 100;
        border-radius: 5px;
        color: rgb(0, 0, 0);
        font-size: 14px;
        margin: 10px 0;
        box-sizing: border-box;
    }

    .timer {
        position: fixed;
        top: 100px;
        right: 10px;
        background-color: #fff;
        padding: 8px 15px;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-size: 16px;
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .timer-icon {
        color: #666;
    }

    /* Styles for completion popup */
    .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        overflow-y: auto;
    }

    .popup-content {
        background-color: white;
        width: 90%;
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .popup-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .popup-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        text-align: center;
    }

    .popup-stat-item {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 6px;
    }

    .popup-stat-label {
        font-size: 12px;
        color: #666;
    }

    .popup-stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-top: 5px;
    }

    .answers-review {
        margin-top: 20px;
    }

    .review-item {
        margin-bottom: 15px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 6px;
    }

    .review-question {
        font-weight: 500;
        margin-bottom: 10px;
    }

    .review-answer {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 5px;
        font-size: 14px;
    }

    .review-answer.correct {
        color: #00a000;
    }

    .review-answer.incorrect {
        color: #ff0000;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        .quiz-overview span {
            font-size: 12px;
        }

        .option-container {
            padding: 8px;
        }

        .stats-panel {
            padding: 8px;
        }

        .question-block h3 {
            font-size: 14px;
        }
    }
</style>

<!-- Timer Component -->
<div class="timer" id="timer">
    <span class="timer-icon">⏱️</span>
    <span id="timer-display">00:00</span>
</div>

<!-- Completion Popup -->
<div class="popup-overlay" id="completion-popup">
    <div class="popup-content">
        <div class="popup-header">
            <h2>Quiz Complete!</h2>
        </div>
        <div class="popup-stats">
            <div class="popup-stat-item">
                <div class="popup-stat-label">Total Questions</div>
                <div class="popup-stat-value" id="popup-total">0</div>
            </div>
            <div class="popup-stat-item">
                <div class="popup-stat-label">Attempted</div>
                <div class="popup-stat-value" id="popup-attempted">0</div>
            </div>
            <div class="popup-stat-item">
                <div class="popup-stat-label">Correct</div>
                <div class="popup-stat-value" id="popup-correct">0</div>
            </div>
            <div class="popup-stat-item">
                <div class="popup-stat-label">Score</div>
                <div class="popup-stat-value" id="popup-percentage">0%</div>
            </div>
        </div>
        <div class="answers-review" id="answers-review">
            <!-- Review items will be inserted here dynamically -->
        </div>
        {% if user.is_authenticated %}
        <a href="/" id="submit-data">Submit and Go to Homepage</a>
        {% else %}
        <a href="/">Go to Homepage</a>
        {% endif %}
    </div>
</div>


<div class="stats-panel">
    <div class="stats-item">
        <span class="stats-label">Progress:</span>
        <span class="stats-value">
            <span id="attempted">0</span>/<span id="total">{{questions_count}}</span>
        </span>
    </div>
    <div class="stats-item">
        <span class="stats-label">Correct:</span>
        <span class="stats-value" id="correct">0</span>
    </div>
    <div class="stats-item">
        <span class="stats-label">Score:</span>
        <span class="stats-value"><span id="percentage">0</span>%</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
</div>

<div class="main-container">
    <h2 style="font-weight: 100; font-size: 20px; text-align: center;" id="quiz-name">{{quiz_name}}</h2>
    <p id="quiz-id" style="display: none;">{{quiz_id}}</p>

    <div class="quiz-overview">
        <span>Questions: {{questions|length}}</span>
        <!-- <span>Time: Untimed</span> -->
        <span>Difficulty: Mixed</span>
    </div>

    <p class="warning-message">
        <i>You can only choose once. Choose wisely.</i>
    </p>

    <div class="quiz-container">
        <form action="" method="post">
            {% csrf_token %}
            {% for question in questions %}
            <div class="question-block" data-question-id="{{question.id}}">
                <h3>{{forloop.counter}}. {{question.question_text}}</h3>
                <div class="options-container">
                    {% for answer in question.shuffled_answers %}
                    <div class="option-container" data-is-correct="{{answer.is_correct|lower}}">
                        <input type="radio" name="{{question.id}}" value="{{answer.id}}" class="radio-input"
                            onchange="checkAnswer(this)" />
                        <span>{{answer}}</span>
                        <span class="answer-feedback"></span>
                    </div>
                    {% endfor %}
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
            </div>
            {% endfor %}
        </form>
    </div>
</div>

<script>
    // Enhanced stats object with popup functionality
    const questionCount = document.getElementById('total').textContent;
    let stats = {
        attempted: 0,
        correct: 0,
        total: questionCount,
        selectedAnswers: new Map(),

        update: function (isCorrect, questionId, selectedAnswer, correctAnswer) {
            this.attempted++;
            if (isCorrect) this.correct++;
            this.selectedAnswers.set(questionId, {
                selected: selectedAnswer,
                correct: correctAnswer,
                isCorrect: isCorrect
            });
            this.updateDisplay();
            this.checkCompletion();
        },

        updateDisplay: function () {
            document.getElementById('attempted').textContent = this.attempted;
            document.getElementById('correct').textContent = this.correct;
            const percentage = this.attempted ? Math.round((this.correct / parseInt(this.attempted)) * 100) : 0;
            document.getElementById('percentage').textContent = percentage;
            document.getElementById('progress-fill').style.width = `${(this.attempted / this.total) * 100}%`;
        },

        checkCompletion: function () {
            console.log(this.attempted, this.total);
            if (this.attempted === parseInt(this.total)) {
                setTimeout(() => this.showCompletionPopup(), 2000);
            }
        },

        showCompletionPopup: function () {
            const popup = document.getElementById('completion-popup');

            // Update popup stats
            document.getElementById('popup-total').textContent = this.total;
            document.getElementById('popup-attempted').textContent = this.attempted;
            document.getElementById('popup-correct').textContent = this.correct;
            document.getElementById('popup-percentage').textContent =
                `${Math.round((this.correct / this.total) * 100)}%`;

            // Generate review items
            const reviewContainer = document.getElementById('answers-review');
            reviewContainer.innerHTML = ''; // Clear existing content

            document.querySelectorAll('.question-block').forEach((block, index) => {
                const questionId = block.dataset.questionId;
                const questionText = block.querySelector('h3').textContent;
                const answerData = this.selectedAnswers.get(questionId);

                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';

                if (answerData) {
                    // Question was answered
                    reviewItem.innerHTML = `
                    <div class="review-question">${questionText}</div>
                    <div class="review-answer ${answerData.isCorrect ? 'correct' : 'incorrect'}">
                        <span>Your answer: ${answerData.selected}</span>
                        ${!answerData.isCorrect ?
                            `<div class="review-answer correct">
                            <span>Correct answer: ${answerData.correct}</span>
                        </div>` : ''
                        }
                    </div>
                `;
                } else {
                    // Question was not answered
                    const correctAnswer = block.querySelector('.option-container[data-is-correct="true"] span').textContent;
                    reviewItem.innerHTML = `
                    <div class="review-question">${questionText}</div>
                    <div class="review-answer incorrect">
                        <span>Not attempted</span>
                        <div class="review-answer correct">
                            <span>Correct answer: ${correctAnswer}</span>
                        </div>
                    </div>
                `;
                }

                reviewContainer.appendChild(reviewItem);
            });

            popup.style.display = 'block';
        }
    };

    // Timer functionality
    const timer = {
        totalSeconds: Math.ceil(questionCount * 0.7 * 60),
        // totalSeconds: Math.ceil(5),

        remainingSeconds: 0,
        timerId: null,

        initialize: function () {
            this.remainingSeconds = this.totalSeconds;
            this.update();
        },

        start: function () {
            this.timerId = setInterval(() => this.tick(), 1000);
        },

        tick: function () {
            this.remainingSeconds--;
            this.update();

            if (this.remainingSeconds <= 0) {
                clearInterval(this.timerId);
                this.timeUp();
            }
        },

        update: function () {
            const minutes = Math.floor(this.remainingSeconds / 60);
            const seconds = this.remainingSeconds % 60;
            document.getElementById('timer-display').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        },

        timeUp: function () {
            // Disable all remaining unchecked radio buttons
            document.querySelectorAll('.radio-input:not(:checked)').forEach(radio => {
                radio.disabled = true;
            });

            // Mark all unanswered questions as incorrect
            document.querySelectorAll('.question-block').forEach(block => {
                const hasAnswer = block.querySelector('input:checked');
                if (!hasAnswer) {
                    // Show correct answer for unanswered questions
                    const correctOption = block.querySelector('.option-container[data-is-correct="true"]');
                    correctOption.classList.add('correct');
                    const feedbackSpan = correctOption.querySelector('.answer-feedback');
                    feedbackSpan.textContent = '✓';
                    feedbackSpan.classList.add('visible');
                }
            });

            // Show completion popup
            stats.showCompletionPopup();
        }
    };

    // Enhanced checkAnswer function
    function checkAnswer(radioButton) {
        const optionContainer = radioButton.closest('.option-container');
        const questionBlock = radioButton.closest('.question-block');
        const allOptions = questionBlock.querySelectorAll('.option-container');
        const allRadios = questionBlock.querySelectorAll('.radio-input');
        const isCorrect = optionContainer.dataset.isCorrect === 'true';

        // Get selected and correct answer text
        const selectedAnswer = optionContainer.querySelector('span').textContent;
        let correctAnswer = '';
        allOptions.forEach(option => {
            if (option.dataset.isCorrect === 'true') {
                correctAnswer = option.querySelector('span').textContent;
            }
        });

        stats.update(isCorrect, questionBlock.dataset.questionId, selectedAnswer, correctAnswer);

        // Rest of the existing checkAnswer function remains the same
        allRadios.forEach(radio => radio.disabled = true);
        allOptions.forEach(option => {
            option.classList.add('disabled');
            option.classList.remove('correct', 'incorrect');
            option.querySelector('.answer-feedback').textContent = '';
            option.querySelector('.answer-feedback').classList.remove('visible');
        });

        const feedbackSpan = optionContainer.querySelector('.answer-feedback');
        if (isCorrect) {
            optionContainer.classList.add('correct');
            feedbackSpan.textContent = '✓';
        } else {
            optionContainer.classList.add('incorrect');
            feedbackSpan.textContent = '✗';

            allOptions.forEach(option => {
                if (option.dataset.isCorrect === 'true') {
                    option.classList.add('correct');
                    option.querySelector('.answer-feedback').textContent = '✓';
                    option.querySelector('.answer-feedback').classList.add('visible');
                }
            });
        }
        feedbackSpan.classList.add('visible');

        // Scroll to next unanswered question
        const nextQuestionBlock = [...document.querySelectorAll('.question-block')]
            .find(block => !block.querySelector('input:disabled'));

        if (nextQuestionBlock) {
            setTimeout(() => {
                nextQuestionBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }
    }

    // Initialize everything when the page loads
    document.addEventListener('DOMContentLoaded', function () {
        stats.total = questionCount;
        stats.updateDisplay();

        // Handle any pre-checked answers
        const checkedInputs = document.querySelectorAll('input[type="radio"]:checked');
        checkedInputs.forEach(input => {
            checkAnswer(input);
        });

        // Initialize timer immediately to show the starting time
        timer.initialize();

        // Start timer after 2 seconds
        setTimeout(() => timer.start(), 2000);
    });

    document.getElementById("submit-data").addEventListener("click", function (e) {
        e.preventDefault();
        const quizResults = {
            total_questions: parseInt(stats.total),
            attempted_questions: stats.attempted,
            correct_answers: stats.correct,
            answers: Array.from(stats.selectedAnswers).map(([questionId, answerData]) => ({
                question_id: questionId,
                selected_answer_id: document.querySelector(`input[name="${questionId}"]:checked`).value,
                is_correct: answerData.isCorrect
            })),
            time_spent: timer.totalSeconds - timer.remainingSeconds,
            quiz_name: document.getElementById('quiz-name').textContent,
            quiz_id: document.getElementById('quiz-id').textContent
        };

        fetch('{% url "save_quiz_results" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(quizResults)
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/';
                } else {
                    console.error('Failed to save quiz results');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });
</script>
{% endblock %}